#!/bin/bash
set -e

echo "ğŸš€ Starting Laravel initialization..."

# å…œåº•ï¼šè‹¥æœªåœ¨ nix-shell ç¯å¢ƒä¸­ï¼Œå°è¯•å†è¿›å…¥ä¸€æ¬¡ï¼ˆä¸€èˆ¬ç”¨ä¸åˆ°ï¼‰
if ! command -v php >/dev/null 2>&1; then
  echo "â„¹ï¸ php not found in PATH, entering nix-shell..."
  exec nix-shell -p php83 php83Extensions.curl php83Extensions.mbstring php83Extensions.fileinfo bash --run "bash init.sh"
fi

# Ensure .env exists
if [ ! -f .env ]; then
  echo "âš™ï¸  .env not found, creating from example..."
  cp .env.example .env || true
fi

# Ensure APP_KEY exists
if ! grep -q "^APP_KEY=" .env || grep -q "^APP_KEY=$" .env; then
  echo "ğŸ”‘ Generating Laravel APP_KEY..."
  php artisan key:generate --force
else
  echo "âœ… APP_KEY already set."
fi

php artisan config:cache || true
php artisan route:cache || true

echo "ğŸŒ Launching Laravel server..."
exec php artisan serve --host=0.0.0.0 --port=$PORT
